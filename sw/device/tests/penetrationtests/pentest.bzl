# Copyright lowRISC contributors (OpenTitan project).
# Licensed under the Apache License, Version 2.0, see LICENSE for details.
# SPDX-License-Identifier: Apache-2.0

"""Pentest case definition"""

load(
    "@lowrisc_opentitan//rules/opentitan:defs.bzl",
    "EARLGREY_SILICON_OWNER_ROM_EXT_ENVS",
    "fpga_params",
    "opentitan_test",
    "silicon_params",
    "verilator_params",
)
load("@rules_python//python:defs.bzl", "py_test")

# Defines default execution environments for penetrationtests targets. All
# opentitan_test must have the following attributes to configure
# each execution environment:
# - cw340
# - silicon
# - verilator
PENTEST_EXEC_ENVS = {
    "@lowrisc_opentitan//hw/top_earlgrey:fpga_cw340_test_rom": "fpga_cw340",
    "@lowrisc_opentitan//hw/top_earlgrey:fpga_cw340_sival_rom_ext": "fpga_cw340",
    "@lowrisc_opentitan//hw/top_earlgrey:fpga_cw340_rom_ext": "fpga_cw340",
    "@lowrisc_opentitan//hw/top_earlgrey:sim_verilator": "verilator",
} | EARLGREY_SILICON_OWNER_ROM_EXT_ENVS

GDB_EXEC_ENVS = {
    "@lowrisc_opentitan//hw/top_earlgrey:fpga_cw340_rom_ext": "fpga_cw340",
}

FIRMWARE_DEPS_FI = [
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/fi:alert_fi",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/fi:crypto_fi",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/fi:ibex_fi",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/fi:lc_ctrl_fi",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/fi:otp_fi",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/fi:rng_fi",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/fi:rom_fi",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/lib:extclk_sca_fi",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/lib:pentest_lib",
    "@lowrisc_opentitan//sw/device/lib/base:csr",
    "@lowrisc_opentitan//sw/device/lib/base:status",
    "@lowrisc_opentitan//sw/device/lib/crypto/drivers:entropy",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:check",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:ottf_main",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:ujson_ottf",
    "@lowrisc_opentitan//sw/device/lib/ujson",

    # Include all JSON commands.
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/json:commands",
]

FIRMWARE_DEPS_FI_IBEX = [
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/fi:ibex_fi",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/lib:pentest_lib",
    "@lowrisc_opentitan//sw/device/lib/base:csr",
    "@lowrisc_opentitan//sw/device/lib/base:status",
    "@lowrisc_opentitan//sw/device/lib/crypto/drivers:entropy",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:check",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:ottf_main",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:ujson_ottf",
    "@lowrisc_opentitan//sw/device/lib/ujson",

    # Include all JSON commands.
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/json:commands",
]

FIRMWARE_DEPS_FI_OTBN = [
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/fi:otbn_fi",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/lib:pentest_lib",
    "@lowrisc_opentitan//sw/device/lib/base:csr",
    "@lowrisc_opentitan//sw/device/lib/base:status",
    "@lowrisc_opentitan//sw/device/lib/crypto/drivers:entropy",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:check",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:ottf_main",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:ujson_ottf",
    "@lowrisc_opentitan//sw/device/lib/ujson",

    # Include all JSON commands.
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/json:commands",
]

FIRMWARE_DEPS_SCA = [
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/sca:aes_sca",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/sca:edn_sca",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/sca:hmac_sca",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/sca:ibex_sca",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/sca:kmac_sca",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/sca:otbn_sca",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/sca:prng_sca",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/sca:sha3_sca",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/sca:trigger_sca",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/lib:extclk_sca_fi",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/lib:pentest_lib",
    "@lowrisc_opentitan//sw/device/lib/base:csr",
    "@lowrisc_opentitan//sw/device/lib/base:status",
    "@lowrisc_opentitan//sw/device/lib/crypto/drivers:entropy",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:check",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:ottf_main",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:ujson_ottf",
    "@lowrisc_opentitan//sw/device/lib/ujson",

    # Include all JSON commands.
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/json:commands",
]

FIRMWARE_DEPS_CRYPTOLIB_FI_SYM = [
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/sca:trigger_sca",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/fi:cryptolib_fi_sym",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/lib:extclk_sca_fi",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/lib:pentest_lib",
    "@lowrisc_opentitan//sw/device/lib/base:csr",
    "@lowrisc_opentitan//sw/device/lib/base:status",
    "@lowrisc_opentitan//sw/device/lib/crypto/drivers:entropy",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:check",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:ottf_main",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:ujson_ottf",
    "@lowrisc_opentitan//sw/device/lib/ujson",

    # Include all JSON commands.
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/json:commands",
]

FIRMWARE_DEPS_CRYPTOLIB_FI_ASYM = [
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/sca:trigger_sca",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/fi:cryptolib_fi_asym",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/lib:extclk_sca_fi",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/lib:pentest_lib",
    "@lowrisc_opentitan//sw/device/lib/base:csr",
    "@lowrisc_opentitan//sw/device/lib/base:status",
    "@lowrisc_opentitan//sw/device/lib/crypto/drivers:entropy",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:check",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:ottf_main",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:ujson_ottf",
    "@lowrisc_opentitan//sw/device/lib/ujson",

    # Include all JSON commands.
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/json:commands",
]

FIRMWARE_DEPS_CRYPTOLIB_SCA_SYM = [
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/sca:cryptolib_sca_sym",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/sca:trigger_sca",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/sca:prng_sca",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/lib:pentest_lib",
    "@lowrisc_opentitan//sw/device/lib/base:csr",
    "@lowrisc_opentitan//sw/device/lib/base:status",
    "@lowrisc_opentitan//sw/device/lib/crypto/drivers:entropy",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:check",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:ottf_main",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:ujson_ottf",
    "@lowrisc_opentitan//sw/device/lib/ujson",

    # Include all JSON commands.
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/json:commands",
]

FIRMWARE_DEPS_CRYPTOLIB_SCA_ASYM = [
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/sca:cryptolib_sca_asym",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/sca:trigger_sca",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/sca:prng_sca",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/lib:pentest_lib",
    "@lowrisc_opentitan//sw/device/lib/base:csr",
    "@lowrisc_opentitan//sw/device/lib/base:status",
    "@lowrisc_opentitan//sw/device/lib/crypto/drivers:entropy",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:check",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:ottf_main",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:ujson_ottf",
    "@lowrisc_opentitan//sw/device/lib/ujson",

    # Include all JSON commands.
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/json:commands",
]

FIRMWARE_DEPS_GDB = [
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/lib:pentest_lib",
    "@lowrisc_opentitan//sw/device/lib/base:csr",
    "@lowrisc_opentitan//sw/device/lib/base:status",
    "@lowrisc_opentitan//sw/device/lib/crypto/drivers:entropy",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:check",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:ottf_main",
    "@lowrisc_opentitan//sw/device/lib/testing/test_framework:ujson_ottf",
    "@lowrisc_opentitan//sw/device/lib/ujson",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/json:gdb_commands",
    "@lowrisc_opentitan//sw/device/tests/penetrationtests/json:pentest_lib_commands",
    "@lowrisc_opentitan//sw/device/lib/dif:rv_core_ibex",
    "@lowrisc_opentitan//sw/device/lib/crypto/impl:status",
]

def pentest_fi(name, test_vectors, test_args, test_harness, tags):
    """A macro for defining a CryptoTest test case.

    Args:
        name: the name of the test.
        test_vectors: the test vectors to use.
        test_args: additional arguments to pass to the test.
        test_harness: the test harness to use.
        tags: indicate the tags for CI.
    """
    opentitan_test(
        name = name,
        srcs = ["@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware:firmware_fi.c"],
        fpga = fpga_params(
            timeout = "moderate",
            data = test_vectors,
            tags = tags,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        fpga_cw340 = fpga_params(
            timeout = "moderate",
            tags = tags,
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        exec_env = PENTEST_EXEC_ENVS,
        silicon = silicon_params(
            timeout = "eternal",
            tags = tags,
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        verilator = verilator_params(
            timeout = "long",
            tags = ["manual"],
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        deps = FIRMWARE_DEPS_FI,
    )

def pentest_fi_ibex(name, test_vectors, test_args, test_harness, tags):
    """A macro for defining a CryptoTest test case.

    Args:
        name: the name of the test.
        test_vectors: the test vectors to use.
        test_args: additional arguments to pass to the test.
        test_harness: the test harness to use.
        tags: indicate the tags for CI.
    """
    opentitan_test(
        name = name,
        srcs = ["@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware:firmware_fi_ibex.c"],
        fpga = fpga_params(
            timeout = "moderate",
            data = test_vectors,
            tags = tags,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        fpga_cw340 = fpga_params(
            timeout = "moderate",
            tags = tags,
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        exec_env = PENTEST_EXEC_ENVS,
        silicon = silicon_params(
            timeout = "eternal",
            tags = tags,
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        verilator = verilator_params(
            timeout = "long",
            tags = ["manual"],
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        deps = FIRMWARE_DEPS_FI_IBEX,
    )

def pentest_fi_otbn(name, test_vectors, test_args, test_harness, tags):
    """A macro for defining a CryptoTest test case.

    Args:
        name: the name of the test.
        test_vectors: the test vectors to use.
        test_args: additional arguments to pass to the test.
        test_harness: the test harness to use.
        tags: indicate the tags for CI.
    """
    opentitan_test(
        name = name,
        srcs = ["@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware:firmware_fi_otbn.c"],
        fpga = fpga_params(
            timeout = "moderate",
            data = test_vectors,
            tags = tags,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        fpga_cw340 = fpga_params(
            timeout = "moderate",
            tags = tags,
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        exec_env = PENTEST_EXEC_ENVS,
        silicon = silicon_params(
            timeout = "eternal",
            tags = tags,
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        verilator = verilator_params(
            timeout = "long",
            tags = ["manual"],
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        deps = FIRMWARE_DEPS_FI_OTBN,
    )

def pentest_sca(name, test_vectors, test_args, test_harness, tags):
    """A macro for defining a CryptoTest test case.

    Args:
        name: the name of the test.
        test_vectors: the test vectors to use.
        test_args: additional arguments to pass to the test.
        test_harness: the test harness to use.
        tags: indicate the tags for CI.
    """
    opentitan_test(
        name = name,
        srcs = ["@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware:firmware_sca.c"],
        fpga = fpga_params(
            timeout = "moderate",
            data = test_vectors,
            tags = tags,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        fpga_cw340 = fpga_params(
            timeout = "moderate",
            tags = tags,
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        exec_env = PENTEST_EXEC_ENVS,
        silicon = silicon_params(
            timeout = "eternal",
            tags = tags,
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        verilator = verilator_params(
            timeout = "long",
            tags = ["manual"],
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        deps = FIRMWARE_DEPS_SCA,
    )

def pentest_cryptolib_fi_sym(name, test_vectors, test_args, test_harness, tags):
    """A macro for defining a CryptoTest test case.

    Args:
        name: the name of the test.
        test_vectors: the test vectors to use.
        test_args: additional arguments to pass to the test.
        test_harness: the test harness to use.
        tags: indicate the tags for CI.
    """
    opentitan_test(
        name = name,
        srcs = ["@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware:firmware_cryptolib_fi_sym.c"],
        fpga = fpga_params(
            timeout = "long",
            data = test_vectors,
            tags = tags,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        fpga_cw340 = fpga_params(
            timeout = "long",
            tags = tags,
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        exec_env = PENTEST_EXEC_ENVS,
        silicon = silicon_params(
            timeout = "eternal",
            tags = tags,
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        verilator = verilator_params(
            timeout = "long",
            tags = ["manual"],
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        deps = FIRMWARE_DEPS_CRYPTOLIB_FI_SYM,
    )

def pentest_cryptolib_fi_gdb_sym(name, test_vectors, test_args, test_harness, tags):
    """A macro for defining a CryptoTest test case.

    Args:
        name: the name of the test.
        test_vectors: the test vectors to use.
        test_args: additional arguments to pass to the test.
        test_harness: the test harness to use.
        tags: indicate the tags for CI.
    """
    opentitan_test(
        name = name,
        srcs = ["@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware:firmware_cryptolib_fi_sym.c"],
        fpga = fpga_params(
            timeout = "eternal",
            data = test_vectors,
            tags = tags,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        fpga_cw340 = fpga_params(
            timeout = "eternal",
            tags = tags,
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        exec_env = GDB_EXEC_ENVS,
        silicon = silicon_params(
            timeout = "eternal",
            tags = tags,
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        verilator = verilator_params(
            timeout = "long",
            tags = ["manual"],
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        deps = FIRMWARE_DEPS_CRYPTOLIB_FI_SYM,
    )

def pentest_cryptolib_fi_asym(name, test_vectors, test_args, test_harness, tags):
    """A macro for defining a CryptoTest test case.

    Args:
        name: the name of the test.
        test_vectors: the test vectors to use.
        test_args: additional arguments to pass to the test.
        test_harness: the test harness to use.
        tags: indicate the tags for CI.
    """
    opentitan_test(
        name = name,
        srcs = ["@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware:firmware_cryptolib_fi_asym.c"],
        fpga = fpga_params(
            timeout = "long",
            data = test_vectors,
            tags = tags,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        fpga_cw340 = fpga_params(
            timeout = "long",
            tags = tags,
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        exec_env = PENTEST_EXEC_ENVS,
        silicon = silicon_params(
            timeout = "eternal",
            tags = tags,
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        verilator = verilator_params(
            timeout = "long",
            tags = ["manual"],
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        deps = FIRMWARE_DEPS_CRYPTOLIB_FI_ASYM,
    )

def pentest_cryptolib_fi_gdb_asym(name, test_vectors, test_args, test_harness, tags):
    """A macro for defining a CryptoTest test case.

    Args:
        name: the name of the test.
        test_vectors: the test vectors to use.
        test_args: additional arguments to pass to the test.
        test_harness: the test harness to use.
        tags: indicate the tags for CI.
    """
    opentitan_test(
        name = name,
        srcs = ["@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware:firmware_cryptolib_fi_asym.c"],
        fpga = fpga_params(
            timeout = "eternal",
            data = test_vectors,
            tags = tags,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        fpga_cw340 = fpga_params(
            timeout = "eternal",
            tags = tags,
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        exec_env = GDB_EXEC_ENVS,
        silicon = silicon_params(
            timeout = "eternal",
            tags = tags,
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        verilator = verilator_params(
            timeout = "long",
            tags = ["manual"],
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        deps = FIRMWARE_DEPS_CRYPTOLIB_FI_ASYM,
    )

def pentest_cryptolib_sca_sym(name, test_vectors, test_args, test_harness, tags):
    """A macro for defining a CryptoTest test case.

    Args:
        name: the name of the test.
        test_vectors: the test vectors to use.
        test_args: additional arguments to pass to the test.
        test_harness: the test harness to use.
        tags: indicate the tags for CI.
    """
    opentitan_test(
        name = name,
        srcs = ["@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware:firmware_cryptolib_sca_sym.c"],
        fpga = fpga_params(
            timeout = "long",
            data = test_vectors,
            tags = tags,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        fpga_cw340 = fpga_params(
            timeout = "long",
            tags = tags,
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        exec_env = PENTEST_EXEC_ENVS,
        silicon = silicon_params(
            timeout = "eternal",
            tags = tags,
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        verilator = verilator_params(
            timeout = "long",
            tags = ["manual"],
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        deps = FIRMWARE_DEPS_CRYPTOLIB_SCA_SYM,
    )

def pentest_cryptolib_sca_asym(name, test_vectors, test_args, test_harness, tags):
    """A macro for defining a CryptoTest test case.

    Args:
        name: the name of the test.
        test_vectors: the test vectors to use.
        test_args: additional arguments to pass to the test.
        test_harness: the test harness to use.
        tags: indicate the tags for CI.
    """
    opentitan_test(
        name = name,
        srcs = ["@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware:firmware_cryptolib_sca_asym.c"],
        fpga = fpga_params(
            timeout = "long",
            data = test_vectors,
            tags = tags,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        fpga_cw340 = fpga_params(
            timeout = "long",
            tags = tags,
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        exec_env = PENTEST_EXEC_ENVS,
        silicon = silicon_params(
            timeout = "eternal",
            tags = tags,
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        verilator = verilator_params(
            timeout = "long",
            tags = ["manual"],
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        deps = FIRMWARE_DEPS_CRYPTOLIB_SCA_ASYM,
    )

def pentest_gdb_unit(name, test_vectors, test_args, test_harness, tags):
    """A macro for defining a CryptoTest test case.

    Args:
        name: the name of the test.
        test_vectors: the test vectors to use.
        test_args: additional arguments to pass to the test.
        test_harness: the test harness to use.
        tags: indicate the tags for CI.
    """
    opentitan_test(
        name = name,
        srcs = ["@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware:firmware_gdb.c"],
        fpga = fpga_params(
            timeout = "long",
            data = test_vectors,
            tags = tags,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        fpga_cw340 = fpga_params(
            timeout = "long",
            tags = tags,
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        exec_env = GDB_EXEC_ENVS,
        silicon = silicon_params(
            timeout = "eternal",
            tags = tags,
            data = test_vectors,
            test_cmd = """
                --bootstrap={firmware}
            """ + test_args,
            test_harness = test_harness,
        ),
        deps = FIRMWARE_DEPS_GDB,
    )

def pentest_rom_fi_gdb(name, test_vectors, test_args, test_harness, tags):
    """A macro for defining a CryptoTest test case.

    Args:
        name: the name of the test.
        test_vectors: the test vectors to use.
        test_args: additional arguments to pass to the test.
        test_harness: the test harness to use.
        tags: indicate the tags for CI.
    """
    opentitan_test(
        name = name,
        exec_env = {
            "@lowrisc_opentitan//hw/top_earlgrey:fpga_cw340_rom_ext": None,
        },
        # Provide a correctly signed BL0 binary
        srcs = ["@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware:firmware_cryptolib_fi_asym.c"],
        fpga = fpga_params(
            timeout = "eternal",
            # We set an OTP with the RMA lifecycle, ensure ROM_EXT can still boot
            otp = "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/testdata:otp_img_rom_ext_fi",
            data = test_vectors,
            tags = tags,
            test_cmd = """
                --bootstrap={firmware} --rom_ext={rom_ext} --rom={rom}
            """ + test_args,
            test_harness = test_harness,
        ),
        deps = FIRMWARE_DEPS_CRYPTOLIB_FI_ASYM,
    )

def pentest_rom_rollback_fi_gdb(name, test_vectors, test_args, test_harness, tags):
    """A macro for defining a CryptoTest test case.

    Args:
        name: the name of the test.
        test_vectors: the test vectors to use.
        test_args: additional arguments to pass to the test.
        test_harness: the test harness to use.
        tags: indicate the tags for CI.
    """
    opentitan_test(
        name = name,
        exec_env = {
            "@lowrisc_opentitan//hw/top_earlgrey:fpga_cw340_rom_ext": None,
        },
        # Provide a correctly signed binary
        srcs = ["@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware:firmware_cryptolib_fi_asym.c"],
        fpga = fpga_params(
            timeout = "eternal",
            # We set an OTP with the RMA lifecycle, ensure ROM_EXT can still boot, set a high security version
            otp = "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/testdata:otp_img_rom_rollback_fi",
            data = test_vectors,
            tags = tags,
            test_cmd = """
                --bootstrap={firmware} --rom_ext={rom_ext} --rom={rom}
            """ + test_args,
            test_harness = test_harness,
        ),
        deps = FIRMWARE_DEPS_CRYPTOLIB_FI_ASYM,
    )

def pentest_rom_ext_fi_gdb(name, test_vectors, test_args, test_harness, tags):
    """A macro for defining a CryptoTest test case.

    Args:
        name: the name of the test.
        test_vectors: the test vectors to use.
        test_args: additional arguments to pass to the test.
        test_harness: the test harness to use.
        tags: indicate the tags for CI.
    """
    opentitan_test(
        name = name,
        exec_env = {
            "@lowrisc_opentitan//hw/top_earlgrey:fpga_cw340_rom_ext": None,
        },
        fpga = fpga_params(
            timeout = "eternal",
            # We set an OTP with the RMA lifecycle, ensure ROM_EXT can still boot
            otp = "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/testdata:otp_img_rom_ext_fi",
            data = test_vectors,
            tags = tags,
            test_cmd = """
                --bootstrap={firmware} --rom_ext={rom_ext} --rom={rom}
            """ + test_args,
            test_harness = test_harness,
            # Specifically provide a wrong signed BL0 image
            binaries = {"@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/testdata:wrong_signed_firmware": "firmware"},
        ),
    )

def pentest_rom_ext_rollback_fi_gdb(name, test_vectors, test_args, test_harness, tags):
    """A macro for defining a CryptoTest test case.

    Args:
        name: the name of the test.
        test_vectors: the test vectors to use.
        test_args: additional arguments to pass to the test.
        test_harness: the test harness to use.
        tags: indicate the tags for CI.
    """
    opentitan_test(
        name = name,
        exec_env = {
            "@lowrisc_opentitan//hw/top_earlgrey:fpga_cw340_rom_ext": None,
        },
        # Provide a correctly signed binary
        srcs = ["@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware:firmware_cryptolib_fi_asym.c"],
        # Provide a manifest with a low security version
        manifest = "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/testdata:rom_ext_rollback_manifest",
        fpga = fpga_params(
            timeout = "eternal",
            # We set an OTP with the RMA lifecycle, ensure ROM_EXT can still boot, set a high security version
            otp = "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/testdata:otp_img_rom_ext_rollback_fi",
            data = test_vectors,
            tags = tags,
            test_cmd = """
                --bootstrap={firmware} --rom_ext={rom_ext} --rom={rom}
            """ + test_args,
            test_harness = test_harness,
        ),
        deps = FIRMWARE_DEPS_CRYPTOLIB_FI_ASYM,
    )

def pentest_rom_ext_imm_skip_fi_gdb(name, test_vectors, test_args, test_harness, tags):
    """A macro for defining a CryptoTest test case.

    Args:
        name: the name of the test.
        test_vectors: the test vectors to use.
        test_args: additional arguments to pass to the test.
        test_harness: the test harness to use.
        tags: indicate the tags for CI.
    """
    opentitan_test(
        name = name,
        exec_env = {
            "@lowrisc_opentitan//hw/top_earlgrey:fpga_cw340_rom_ext": None,
        },
        # Provide a correctly signed binary
        srcs = ["@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware:firmware_cryptolib_fi_asym.c"],
        manifest = "@lowrisc_opentitan//sw/device/silicon_owner:manifest",
        fpga = fpga_params(
            timeout = "eternal",
            # We set an OTP with the RMA lifecycle, ensure ROM_EXT can still boot, but give a bogus ROM_EXT_IMM hash
            otp = "@lowrisc_opentitan//sw/device/tests/penetrationtests/firmware/testdata:otp_img_rom_ext_imm_skip_fi",
            data = test_vectors,
            tags = tags,
            test_cmd = """
                --bootstrap={firmware} --rom_ext={rom_ext} --rom={rom}
            """ + test_args,
            test_harness = test_harness,
            rom_ext = "@lowrisc_opentitan//sw/device/silicon_creator/rom_ext:rom_ext_dice_x509_slot_virtual",
        ),
        deps = FIRMWARE_DEPS_CRYPTOLIB_FI_ASYM,
    )
