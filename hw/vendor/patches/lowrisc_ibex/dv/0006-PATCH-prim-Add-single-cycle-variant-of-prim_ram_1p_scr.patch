From db849df4c05690a2016fb2eb47de9badd8aad84b Mon Sep 17 00:00:00 2001
From: Andreas Kurth <adk@lowrisc.org>
Date: Fri, 21 Mar 2025 19:35:18 +0000
Subject: [PATCH] [prim] Add single-cycle variant of `prim_ram_1p_scr`

Ibex (data and tags of instruction cache) and OTBN (data and instruction
memory) use `prim_ram_1p_scr` in a particular way:  They ignore the
`gnt_o` (and, in the case of Ibex, also the `rvalid_o`) signal, hence
assuming that `prim_ram_1p_scr` is always able to handle requests and
will provide a response in the next cycle.  This is true for
the current implementation of `prim_ram_1p_scr`, but it means `gnt_o`
and `rvalid_o` cannot be used for flow control, which is problematic for
upcoming changes to `prim_ram_1p_scr`.

This commit thus creates a variant of `prim_ram_1p_scr` with a `_1cyc`
suffix.  This variant is always ready for requests and always responds
in the next cycle.

As there's a circular dependency on this change with the Ibex repo,
which gets vendored into this repo, this commit applies a patch to Ibex.
Once this commit has been merged and the Ibex repo has been updated,
that patch can be removed.

Signed-off-by: Andreas Kurth <adk@lowrisc.org>
---
 uvm/icache/dv/tb/tb.sv | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/uvm/icache/dv/tb/tb.sv b/uvm/icache/dv/tb/tb.sv
index 0b1d0e0018..0d7863bff3 100644
--- a/uvm/icache/dv/tb/tb.sv
+++ b/uvm/icache/dv/tb/tb.sv
@@ -131,7 +131,7 @@ module tb #(
   // RAMs
   for (genvar way = 0; way < IC_NUM_WAYS; way++) begin : gen_rams
     // Tag RAM instantiation
-    prim_ram_1p_scr #(
+    prim_ram_1p_scr_1cyc #(
       .Width            (TagSizeECC),
       .Depth            (IC_NUM_LINES),
       .DataBitsPerMask  (TagSizeECC),
@@ -165,7 +165,7 @@ module tb #(
     );
 
     // Data RAM instantiation
-    prim_ram_1p_scr #(
+    prim_ram_1p_scr_1cyc #(
       .Width              (LineSizeECC),
       .Depth              (IC_NUM_LINES),
       .DataBitsPerMask    (LineSizeECC),
-- 
2.34.1

