# Signing Ceremony 2025-03-30

- Purpose:
  - Release new ROM\_EXT (version 0.104) binaries for prod Earlgrey A* silicon SKUs.
  - Release new FT personalization binaries for prod Earlgrey A* silicon SKUs.
- Participants: timothytrippel(leader), cfrantz (witness), moidx (witness).

## Ceremony Prolog

Before the ceremony, we double checked build reproducibility.
With the following repos at their respective commits:
- `opentitan:earlgrey_1.0.0` on commit a5c3410dcdf83ba5a63e4c39e0fa42a8f783ddcb,
we ran:

```
$ bazel build --stamp \
    //sw/device/silicon_creator/manuf/base:digests \
    //sw/device/silicon_creator/rom_ext/sival:digests \
    //sw/host/hsmtool
$ sha256sum \
    bazel-out/k8-fastbuild/bin/sw/device/silicon_creator/manuf/base/ft_personalize_sival_fpga_cw340_rom_with_fake_keys.digest \
    bazel-out/k8-fastbuild/bin/sw/device/silicon_creator/manuf/base/ft_personalize_sival_fpga_hyper310_rom_with_fake_keys.digest \
    bazel-out/k8-fastbuild/bin/sw/device/silicon_creator/manuf/base/ft_personalize_sival_silicon_creator.digest \
    bazel-out/k8-fastbuild/bin/sw/device/silicon_creator/rom_ext/sival/digests.tar \
28f696233ee45765267ce8c00cb789c7d667a8958d3d60921d624c0ab94a06fc  bazel-out/k8-fastbuild/bin/sw/device/silicon_creator/manuf/base/ft_personalize_sival_fpga_cw340_rom_with_fake_keys.digest
b1e2c4cc64da30a45b52d1ebab07c1440ad5df3890d998c329f6b2b61037c565  bazel-out/k8-fastbuild/bin/sw/device/silicon_creator/manuf/base/ft_personalize_sival_fpga_hyper310_rom_with_fake_keys.digest
164c7851de04f9744ab78e3a89e22840684ebf4486db27e78696f26223c46670  bazel-out/k8-fastbuild/bin/sw/device/silicon_creator/manuf/base/ft_personalize_sival_silicon_creator.digest
0662ce7115b81b2ceae7015f8deb04d0c3284ea55d3699399d148ca3823588e4 bazel-out/k8-fastbuild/bin/sw/device/silicon_creator/rom_ext/sival/digests.tar
```

We copied the digests and `hsmtool` to a staging subdirectory.
```
$ mkdir -p ${STAGING_DIR}
$ cp bazel-bin/sw/host/hsmtool/hsmtool ${STAGING_DIR}
$ cp bazel-out/k8-fastbuild/bin/sw/device/silicon_creator/manuf/base/digests.tar ${STAGING_DIR}/perso.tar
$ cp bazel-out/k8-fastbuild/bin/sw/device/silicon_creator/rom_ext/sival/digests.tar ${STAGING_DIR}/rom_ext.tar
```

## NitroKey Preparation

In order to communicate with the NitroKey token holding the key material, we used the `opensc` package.

## Ceremony

### Setup & Authenticate to the HSM

```
$ cd ${STAGING_DIR}
$ export HSMTOOL_MODULE=/usr/lib/x86_64-linux-gnu/opensc-pkcs11.so
$ ./hsmtool token list
{
  "tokens": [
    {
      "label": "earlgrey_a1",
      "manufacturer_id": "www.cardcontact.de",
      "model": "SmartCard-HSM"
      "serial_number": "DENK0107146"
    }
  ]
}
$ export HSMTOOL_SPX_MODULE=pkcs11-ef
```

## Signing

Signing was performed in the staging subdirectory.
I have an `hsmtool` profile defined named `earlgrey_a1` which supplies the username and PIN.

### Sival ROM\_EXT signatures

```
$ mkdir rom_ext
$ cd rom_ext
$ tar xvf ../rom_ext.tar
$ ../hsmtool --profile earlgrey_a1_opensc exec presigning.json
$ cd ..
```

### Personalization signatures

```
$ mkdir perso
$ cd perso
$ tar xvf ../perso.tar
$ ../hsmtool -t earlgrey_a1 -u user -p ${PIN} exec provisioning_sival.json
$ cd ..
```

## Ceremony Epilog

After signing, the signatures were collected so they could be tested prior to
publishing the signatures and binaries.

```
$ tar cvf signatures.tar */*_sig
...
$ exit
```

### Attaching signatures

The following command was used to attach the signatures to the ROM\_EXT and personalization binaries:

```
bazel build --stamp \
    //sw/device/silicon_creator/manuf/base:signed \
    //sw/device/silicon_creator/rom_ext/sival:signed
```
