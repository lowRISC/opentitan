# Copyright lowRISC contributors (OpenTitan project).
# Licensed under the Apache License, Version 2.0, see LICENSE for details.
# SPDX-License-Identifier: Apache-2.0
name: 'Check for and block unauthorized changes'

on:
  pull_request_target:

permissions:
  contents: read
  # Needed to read comments for authorizations
  pull-requests: read

jobs:
  check-changes:
    runs-on: "ubuntu-latest"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Get whole Git history.

      - name: Determine changed files
        run: |
          git fetch origin "${{ github.event.pull_request.merge_commit_sha }}"
          git diff "${{ github.event.pull_request.merge_commit_sha }}" --name-only \
            | tee "${{ runner.temp }}/changed_files"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for blocked changes
        run: |
          ./ci/scripts/check-pr-changes-allowed.py "${{ runner.temp }}/changed_files" \
            --gh-repo ${{ github.repository }} \
            --gh-token ${{ secrets.GITHUB_TOKEN }} \
            --pr-number ${{ github.event.number }}
