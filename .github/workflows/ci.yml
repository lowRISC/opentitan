# Copyright lowRISC contributors (OpenTitan project).
# Licensed under the Apache License, Version 2.0, see LICENSE for details.
# SPDX-License-Identifier: Apache-2.0

name: CI
on:
  pull_request:
  push:
    branches-ignore:
      - "backport-*"
      - "gh-readonly-queue/**"
    tags:
      - "*"
  merge_group:
    types:
      - checks_requested

permissions:
  contents: read
  # Needed for workload identity federation
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  VIVADO_VERSION: "2021.1"
  # Release tag from https://github.com/lowRISC/lowrisc-toolchains/releases
  TOOLCHAIN_VERSION: 20220210-1

jobs:
  quick_lint:
    name: Lint (quick)
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required so we can lint commit messages.
      - name: Prepare environment
        uses: ./.github/actions/prepare-env
        with:
          service_account_json: '${{ secrets.BAZEL_CACHE_CREDS }}'
      - name: Show environment
        run: ./ci/scripts/show-env.sh

  show_bazel_generate_diff:
    name: Show diff of Bazel generated files
    runs-on: ubuntu-22.04
    needs: quick_lint
    if: ${{ github.event_name != 'merge_group' }}
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJSON(github) }}
        run: echo "$GITHUB_CONTEXT"
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required so we can lint commit messages.
      - run: git log --oneline | head -10
      - name: Prepare environment
        uses: ./.github/actions/prepare-env
        with:
          service_account_json: '${{ secrets.BAZEL_CACHE_CREDS }}'
      - name: Build tar of new generated files
        run: |
          ./bazelisk.sh build //doc:doxygen_srcs_tar
          cp $(./bazelisk.sh cquery //doc:doxygen_srcs_tar) b.tar
          ls
      - run: git checkout HEAD^
      - name: Build tar of old generated files
        run: |
          git log --oneline | head -20
          ./bazelisk.sh build //doc:doxygen_srcs_tar
          cp $(./bazelisk.sh cquery //doc:doxygen_srcs_tar) a.tar
          ls
      - name: Upload archives
        uses: actions/upload-artifact@v4
        with:
            name: bazel-generated-files
            path: |
              a.tar
              b.tar
            # In case this is from a re-run
            overwrite: true