# Copyright lowRISC contributors (OpenTitan project).
# Licensed under the Apache License, Version 2.0, see LICENSE for details.
# SPDX-License-Identifier: Apache-2.0
#
# Azure Pipelines CI build configuration
# Documentation at https://aka.ms/yaml

variables:
  #
  # If updating VERILATOR_VERSION, TOOLCHAIN_VERSION, update the
  # definitions in util/container/Dockerfile as well.
  #
  VERILATOR_VERSION: 4.210
  TOOLCHAIN_PATH: /opt/buildcache/riscv
  VERIBLE_VERSION: v0.0-2135-gb534c1fe
  # Release tag from https://github.com/lowRISC/lowrisc-toolchains/releases
  TOOLCHAIN_VERSION: 20220210-1
  # This controls where builds happen, and gets picked up by build_consts.sh.
  BUILD_ROOT: $(Build.ArtifactStagingDirectory)
  VIVADO_VERSION: "2021.1"

trigger:
  batch: true
  branches:
    include:
    - "*"
    # Don't run workflow on auto-created backport branches (PR workflow will be run)
    exclude:
    - "backport-*"
  tags:
    include:
    - "*"
pr:
  branches:
    include:
    - "*"

jobs:
- job: checkout
  displayName: Checkout repository
  pool:
    vmImage: ubuntu-20.04
  steps:
  - checkout: self
    path: opentitan-repo
  - bash: |
      tar -C $(Pipeline.Workspace)/opentitan-repo -czf $(Pipeline.Workspace)/opentitan-repo.tar.gz .
    displayName: Pack up repository
  - publish: $(Pipeline.Workspace)/opentitan-repo.tar.gz
    artifact: opentitan-repo
    displayName: Upload repository

- job: sw_build
  displayName: Earl Grey SW Build
  # Build software tests for the Earl Grey toplevel design
  timeoutInMinutes: 120
  dependsOn: checkout
  pool: ci-public
  steps:
  - template: ci/checkout-template.yml
  - template: ci/install-package-dependencies.yml
  - template: ci/load-bazel-cache-write-creds.yml
  - bash: |
      set -x -e

      # Check the entire build graph for conflicts in loading or analysis
      # phases. For context, see issue #18726.
      # First, test with an empty bitstream cache entry.
      ci/scripts/test-empty-bitstream-cache.sh
      # Now redo with the real bitstream cache included.
      ci/bazelisk.sh build --nobuild //...

      # This command selects the unit tests to be built:
      # * It excludes //quality because that's the purview of `slow_lints`.
      # * It excludes //sw/otbn/crypto because that's tested in `otbn_crypto_tests`.
      # * It excludes the tests from //third_party/riscv-compliance because
      #   they're already covered by `execute_fpga_tests_cw310`.
      # * It excludes //hw:all to avoid building Verilator, which is pulled in
      #   because //... effectively asks to build //hw:verilator_real and other
      #   targets in //hw:all that depend on it. Note that this is only a
      #   shallow exclusion; tests deeper under //hw will still be found.
      # * It excludes targets that depend on bitstream_splice rules, since the
      #   environment does not have access to Vivado.
      TARGET_PATTERN_FILE=target_pattern.txt
      echo //... > "${TARGET_PATTERN_FILE}"
      echo -//quality/... >> "${TARGET_PATTERN_FILE}"
      echo -//sw/otbn/crypto/... >> "${TARGET_PATTERN_FILE}"
      echo -//third_party/riscv-compliance/... >> "${TARGET_PATTERN_FILE}"
      echo -//hw:all >> "${TARGET_PATTERN_FILE}"
      ci/bazelisk.sh cquery \
        --noinclude_aspects \
        --output=starlark \
        --starlark:expr='"-{}".format(target.label)' \
        --define DISABLE_VERILATOR_BUILD=true \
        -- "rdeps(//..., kind(bitstream_splice, //...))" \
        >> "${TARGET_PATTERN_FILE}"

      # Build all unit tests and their dependencies.
      ci/bazelisk.sh build \
        --build_tests_only=false \
        --define DISABLE_VERILATOR_BUILD=true \
        --test_tag_filters=-broken,-cw310,-verilator,-dv \
        --target_pattern_file="${TARGET_PATTERN_FILE}"
    displayName: Build SW
  - publish: target_pattern.txt
    artifact: target_pattern_file
  - bash: |
      set -x -e
      . util/build_consts.sh
      # copy the rom to a specific location
      ROM_TARGET="${BIN_DIR}/sw/device/silicon_creator/rom"
      mkdir -p "${ROM_TARGET}"
      ROM_REAL_TARGETS="//sw/device/silicon_creator/rom:package_real"
      ROM_FAKE_TARGETS="//sw/device/silicon_creator/rom:package_fake"
      QUERY_CMD_ARGS=(outquery-all --noinclude_aspects --noimplicit_deps)
      ROM_REAL_FILES=($(ci/bazelisk.sh "${QUERY_CMD_ARGS[@]}" "${ROM_REAL_TARGETS}" | sort | uniq))
      ROM_FAKE_FILES=($(ci/bazelisk.sh "${QUERY_CMD_ARGS[@]}" "${ROM_FAKE_TARGETS}" | sort | uniq))
      cp -Lvt "${ROM_TARGET}" "${ROM_FAKE_FILES[@]}" "${ROM_REAL_FILES[@]}"
  - template: ci/upload-artifacts-template.yml
    parameters:
      includePatterns:
        - "/sw/***"

- job: chip_earlgrey_cw310_hyperdebug
  displayName: CW310's Earl Grey Bitstream for Hyperdebug
  # Build CW310-hyperdebug variant of the Earl Grey toplevel design using Vivado
  dependsOn:
    - checkout
  pool: ci-public-eda
  timeoutInMinutes: 240
  steps:
  - template: ci/fpga-template.yml
    parameters:
      top_name: earlgrey
      design_suffix: cw310_hyperdebug

# - job: execute_sival_fpga_tests_cw310
#   displayName: CW310 SiVal non-ROM_EXT Tests
#   pool:
#     name: $(fpga_pool)
#     demands: BOARD -equals cw310
#   timeoutInMinutes: 75
#   dependsOn:
#     - chip_earlgrey_cw310_hyperdebug
#     - sw_build
#   condition: succeeded( 'chip_earlgrey_cw310_hyperdebug', 'sw_build' )
#   steps:
#   - template: ci/checkout-template.yml
#   - template: ci/install-package-dependencies.yml
#   - template: ci/download-artifacts-template.yml
#     parameters:
#       downloadPartialBuildBinFrom:
#         - chip_earlgrey_cw310_hyperdebug
#         - sw_build
#   - template: ci/load-bazel-cache-write-creds.yml
#   # We run the update command twice to workaround an issue with udev on the container,
#   # where rusb cannot dynamically update its device list in CI (udev is not completely
#   # functional). If the device is in normal mode, the first thing that opentitantool
#   # does is to switch it to DFU mode and wait until it reconnects. This reconnection is
#   # never detected. But if we run the tool another time, the device list is queried again
#   # and opentitantool can finish the update. The device will now reboot in normal mode
#   # and work for the hyperdebug job.
#   - bash: |
#       ci/bazelisk.sh run \
#         //sw/host/opentitantool:opentitantool -- \
#         --interface=hyperdebug_dfu transport update-firmware \
#       || ci/bazelisk.sh run \
#         //sw/host/opentitantool:opentitantool -- \
#         --interface=hyperdebug_dfu transport update-firmware || true
#     displayName: "Update the hyperdebug firmware"
#   - bash: |
#       set -e
#       . util/build_consts.sh
#       module load "xilinx/vivado/$(VIVADO_VERSION)"
#       ci/scripts/run-fpga-tests.sh hyper310 cw310_sival_but_not_rom_ext_tests || { res=$?; echo "To reproduce failures locally, follow the instructions at https://opentitan.org/book/doc/getting_started/setup_fpga.html#reproducing-fpga-ci-failures-locally"; exit "${res}"; }
#     displayName: Execute tests
#   - template: ci/publish-bazel-test-results.yml

- job: execute_sival_rom_ext_fpga_tests_cw310
  displayName: CW310 SiVal ROM_EXT Tests
  pool:
    name: $(fpga_pool)
    demands: BOARD -equals cw310
  timeoutInMinutes: 60
  dependsOn:
    - chip_earlgrey_cw310_hyperdebug
    - sw_build
  condition: succeeded( 'chip_earlgrey_cw310_hyperdebug', 'sw_build' )
  steps:
  - template: ci/checkout-template.yml
  - template: ci/install-package-dependencies.yml
  - template: ci/download-artifacts-template.yml
    parameters:
      downloadPartialBuildBinFrom:
        - chip_earlgrey_cw310_hyperdebug
        - sw_build
  - template: ci/load-bazel-cache-write-creds.yml
  # We run the update command twice to workaround an issue with udev on the container,
  # where rusb cannot dynamically update its device list in CI (udev is not completely
  # functional). If the device is in normal mode, the first thing that opentitantool
  # does is to switch it to DFU mode and wait until it reconnects. This reconnection is
  # never detected. But if we run the tool another time, the device list is queried again
  # and opentitantool can finish the update. The device will now reboot in normal mode
  # and work for the hyperdebug job.
  - bash: |
      ci/bazelisk.sh run \
        //sw/host/opentitantool:opentitantool -- \
        --interface=hyperdebug_dfu transport update-firmware \
      || ci/bazelisk.sh run \
        //sw/host/opentitantool:opentitantool -- \
        --interface=hyperdebug_dfu transport update-firmware || true
    displayName: "Update the hyperdebug firmware"
  - bash: |
      set -e
      . util/build_consts.sh
      module load "xilinx/vivado/$(VIVADO_VERSION)"
      ci/scripts/run-fpga-tests.sh hyper310 cw310_sival_rom_ext || { res=$?; echo "To reproduce failures locally, follow the instructions at https://opentitan.org/book/doc/getting_started/setup_fpga.html#reproducing-fpga-ci-failures-locally"; exit "${res}"; }
    displayName: Execute tests
  - template: ci/publish-bazel-test-results.yml
